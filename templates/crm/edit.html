{% extends 'base_luxury.html' %}

{% block title %}Edit Guest - {{ guest.full_name }}{% endblock %}
{% block page_title %}Edit Guest{% endblock %}
{% block page_subtitle %}{{ guest.full_name }}{% endblock %}

{% block content %}
{% if not can_edit_guests %}
<div class="max-w-2xl mx-auto text-center py-16">
    <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-lock text-red-600 text-2xl"></i>
    </div>
    <h3 class="text-2xl font-bold text-gray-900 mb-4">Access Denied</h3>
    <p class="text-gray-600 mb-8">You don't have permission to edit guest profiles. Please contact your administrator.</p>
    <a href="{% url 'crm:list' %}" class="inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>
        Back to Guests
    </a>
</div>
{% else %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-3xl p-8 luxury-shadow">
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            <!-- Guest Type Selection -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6 mb-6">
                <h4 class="text-blue-800 font-semibold mb-4 flex items-center">
                    <i class="fas fa-user-tag text-blue-600 mr-2"></i>
                    Guest Type
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-blue-700 font-semibold mb-3" for="guest_type">
                            Guest Type *
                        </label>
                        <select name="guest_type" id="guest_type" 
                                class="w-full px-4 py-3 border-2 border-blue-200 rounded-2xl focus:border-blue-500 focus:outline-none transition-colors" 
                                onchange="toggleCompanyField()" required>
                            <option value="">Select guest type</option>
                            <option value="individual" {% if guest.guest_type == 'individual' %}selected{% endif %}>Individual</option>
                            <option value="company" {% if guest.guest_type == 'company' %}selected{% endif %}>Company</option>
                        </select>
                    </div>
                    
                    <div id="company-field" {% if guest.guest_type != 'company' %}style="display: none;"{% endif %}>
                        <label class="block text-blue-700 font-semibold mb-3" for="company">
                            Company *
                        </label>
                        <select name="company" id="company" 
                                class="w-full px-4 py-3 border-2 border-blue-200 rounded-2xl focus:border-blue-500 focus:outline-none transition-colors">
                            <option value="">Select a company</option>
                            {% for company in companies %}
                                <option value="{{ company.id }}" {% if guest.company.id == company.id %}selected{% endif %}>{{ company.name }}</option>
                            {% endfor %}
                        </select>
                        <p class="text-xs text-blue-600 mt-1">Select the company this guest represents</p>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">First Name</label>
                    <input type="text" name="first_name" value="{{ guest.first_name }}" required
                           class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Last Name</label>
                    <input type="text" name="last_name" value="{{ guest.last_name }}" required
                           class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Email</label>
                    <input type="email" name="email" value="{{ guest.email }}" required
                           class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Phone</label>
                    <input type="tel" name="phone" id="phone" value="{{ guest.phone }}"
                           class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Gender <span class="text-gray-500 text-xs">(Optional)</span></label>
                    <select name="gender" class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                        <option value="">Select gender</option>
                        <option value="male" {% if guest.gender == 'male' %}selected{% endif %}>Male</option>
                        <option value="female" {% if guest.gender == 'female' %}selected{% endif %}>Female</option>
                        <option value="other" {% if guest.gender == 'other' %}selected{% endif %}>Other</option>
                        <option value="prefer_not_to_say" {% if guest.gender == 'prefer_not_to_say' %}selected{% endif %}>Prefer not to say</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Date of Birth</label>
                    <input type="date" name="date_of_birth" value="{{ guest.date_of_birth|date:'Y-m-d' }}"
                           class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Nationality</label>
                    <select name="nationality" id="nationality" class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                        <option value="">Select Country</option>
                        {% load countries %}
                        {% get_countries as countries %}
                        {% for code, name in countries %}
                            <option value="{{ code }}" {% if guest.nationality == code %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-luxury-700 mb-2">Address</label>
                <textarea name="address" rows="3"
                          class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">{{ guest.address }}</textarea>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Passport Number <span class="text-gray-500 text-xs">(For foreign guests)</span></label>
                    <input type="text" name="passport_number" value="{{ guest.passport_number }}"
                           class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Visa Number <span class="text-gray-500 text-xs">(For international guests)</span></label>
                    <input type="text" name="visa_number" value="{{ guest.visa_number }}"
                           class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-luxury-700 mb-2">National ID Card {% if not user.is_superuser %}*{% endif %}</label>
                <input type="text" name="national_id_card" value="{{ guest.national_id_card }}" {% if not user.is_superuser %}required{% endif %}
                       class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent"
                       placeholder="National Identity Card Number">
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Emergency Contact Name <span class="text-gray-500 text-xs">(Safety)</span></label>
                    <input type="text" name="emergency_contact_name" value="{{ guest.emergency_contact_name }}"
                           class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-luxury-700 mb-2">Emergency Contact Phone <span class="text-gray-500 text-xs">(Safety)</span></label>
                    <input type="tel" name="emergency_contact_phone" value="{{ guest.emergency_contact_phone }}"
                           class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-luxury-700 mb-2">National ID Card Image</label>
                {% if guest.national_id_card_image %}
                    <div class="mb-3">
                        <img src="{{ guest.national_id_card_image.url }}" alt="Current ID Card" class="w-32 h-20 object-cover rounded-lg border">
                        <p class="text-xs text-gray-500 mt-1">Current image</p>
                    </div>
                {% endif %}
                <input type="file" name="national_id_card_image"
                       class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent"
                       accept="image/*">
                <p class="text-xs text-gray-500 mt-1">Upload a new image to replace the current one</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-luxury-700 mb-2">Notes</label>
                <textarea name="notes" rows="3"
                          class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">{{ guest.notes }}</textarea>
            </div>
            
            <div class="flex space-x-4">
                <button type="submit" class="bg-royal-500 text-white px-6 py-3 rounded-xl hover:bg-royal-600 transition-colors">
                    <i class="fas fa-save mr-2"></i>Update Guest
                </button>
                <a href="{% url 'crm:detail' guest.id %}" class="bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600 transition-colors">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
const countryPhoneCodes = {
    'US': '+1', 'CA': '+1', 'GB': '+44', 'AU': '+61', 'DE': '+49', 'FR': '+33', 'IT': '+39', 'ES': '+34',
    'NL': '+31', 'BE': '+32', 'CH': '+41', 'AT': '+43', 'SE': '+46', 'NO': '+47', 'DK': '+45', 'FI': '+358',
    'IE': '+353', 'PT': '+351', 'GR': '+30', 'PL': '+48', 'CZ': '+420', 'HU': '+36', 'SK': '+421', 'SI': '+386',
    'HR': '+385', 'BG': '+359', 'RO': '+40', 'LT': '+370', 'LV': '+371', 'EE': '+372', 'IS': '+354', 'MT': '+356',
    'CY': '+357', 'LU': '+352', 'MC': '+377', 'SM': '+378', 'VA': '+379', 'AD': '+376', 'LI': '+423',
    'JP': '+81', 'KR': '+82', 'CN': '+86', 'IN': '+91', 'PK': '+92', 'BD': '+880', 'LK': '+94', 'MY': '+60',
    'SG': '+65', 'TH': '+66', 'VN': '+84', 'PH': '+63', 'ID': '+62', 'TW': '+886', 'HK': '+852', 'MO': '+853',
    'MN': '+976', 'KH': '+855', 'LA': '+856', 'MM': '+95', 'BT': '+975', 'MV': '+960', 'NP': '+977',
    'AF': '+93', 'IR': '+98', 'IQ': '+964', 'SA': '+966', 'AE': '+971', 'QA': '+974', 'KW': '+965', 'BH': '+973',
    'OM': '+968', 'YE': '+967', 'JO': '+962', 'LB': '+961', 'SY': '+963', 'IL': '+972', 'PS': '+970', 'TR': '+90',
    'EG': '+20', 'LY': '+218', 'TN': '+216', 'DZ': '+213', 'MA': '+212', 'SD': '+249', 'ET': '+251', 'KE': '+254',
    'UG': '+256', 'TZ': '+255', 'RW': '+250', 'BI': '+257', 'DJ': '+253', 'SO': '+252', 'ER': '+291', 'SS': '+211',
    'ZA': '+27', 'NA': '+264', 'BW': '+267', 'ZW': '+263', 'ZM': '+260', 'MW': '+265', 'MZ': '+258', 'MG': '+261',
    'MU': '+230', 'SC': '+248', 'KM': '+269', 'RE': '+262', 'YT': '+262', 'SH': '+290', 'CV': '+238', 'ST': '+239',
    'GQ': '+240', 'GA': '+241', 'CG': '+242', 'CD': '+243', 'CF': '+236', 'CM': '+237', 'TD': '+235', 'NE': '+227',
    'NG': '+234', 'BJ': '+229', 'TG': '+228', 'GH': '+233', 'CI': '+225', 'LR': '+231', 'SL': '+232', 'GN': '+224',
    'GW': '+245', 'GM': '+220', 'SN': '+221', 'MR': '+222', 'ML': '+223', 'BF': '+226', 'NI': '+505', 'AO': '+244',
    'BR': '+55', 'AR': '+54', 'CL': '+56', 'PE': '+51', 'CO': '+57', 'VE': '+58', 'EC': '+593', 'BO': '+591',
    'PY': '+595', 'UY': '+598', 'GY': '+592', 'SR': '+597', 'GF': '+594', 'FK': '+500', 'MX': '+52', 'GT': '+502',
    'BZ': '+501', 'SV': '+503', 'HN': '+504', 'CR': '+506', 'PA': '+507', 'CU': '+53', 'JM': '+1876', 'HT': '+509',
    'DO': '+1809', 'PR': '+1787', 'TT': '+1868', 'BB': '+1246', 'GD': '+1473', 'LC': '+1758', 'VC': '+1784',
    'AG': '+1268', 'DM': '+1767', 'KN': '+1869', 'BS': '+1242', 'RU': '+7', 'KZ': '+7', 'UZ': '+998', 'TM': '+993',
    'TJ': '+992', 'KG': '+996', 'BY': '+375', 'UA': '+380', 'MD': '+373', 'GE': '+995', 'AM': '+374', 'AZ': '+994'
};

function toggleCompanyField() {
    const guestType = document.getElementById('guest_type');
    const companyField = document.getElementById('company-field');
    const companySelect = document.getElementById('company');
    
    if (guestType && companyField && companySelect) {
        if (guestType.value === 'company') {
            companyField.style.display = 'block';
            companySelect.required = true;
        } else {
            companyField.style.display = 'none';
            companySelect.required = false;
            companySelect.value = '';
        }
    }
}

function updatePhoneCode() {
    const nationalitySelect = document.getElementById('nationality');
    const phoneInput = document.getElementById('phone');
    
    if (nationalitySelect && phoneInput) {
        const selectedCountry = nationalitySelect.value;
        const phoneCode = countryPhoneCodes[selectedCountry];
        
        if (phoneCode) {
            const currentValue = phoneInput.value;
            // Remove existing country code if present
            let phoneNumber = currentValue.replace(/^\+\d+\s*/, '');
            phoneInput.value = phoneCode + ' ' + phoneNumber;
            phoneInput.focus();
            phoneInput.setSelectionRange(phoneInput.value.length, phoneInput.value.length);
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const guestType = document.getElementById('guest_type');
    if (guestType) {
        guestType.addEventListener('change', toggleCompanyField);
        toggleCompanyField();
    }
    
    const nationalitySelect = document.getElementById('nationality');
    if (nationalitySelect) {
        nationalitySelect.addEventListener('change', updatePhoneCode);
    }
});
</script>

<style>
    .luxury-shadow {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
</style>
{% endif %}
{% endblock %}