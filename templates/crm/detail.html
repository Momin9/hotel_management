{% extends 'base_luxury.html' %}

{% block title %}{{ guest.full_name }} - Guest Details{% endblock %}
{% block page_title %}Guest Details{% endblock %}
{% block page_subtitle %}{{ guest.full_name }} ‚Ä¢ Member since {{ guest.created_at|date:"M Y" }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-8">
    <!-- Guest Profile Card -->
    <div class="bg-white rounded-3xl p-8 luxury-shadow">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-6">
                <div class="w-20 h-20 bg-gradient-to-r from-royal-400 to-royal-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl">
                    {{ guest.first_name.0 }}{{ guest.last_name.0 }}
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-luxury-900">{{ guest.full_name }}</h2>
                    <p class="text-luxury-600 text-lg">{{ guest.email }}</p>
                    <p class="text-luxury-500">
                        {% if guest.guest_type == 'company' %}
                            <i class="fas fa-building mr-1"></i>{{ guest.company.name }}
                        {% else %}
                            <i class="fas fa-user mr-1"></i>Individual Guest
                        {% endif %}
                    </p>
                </div>
            </div>
            
            <div class="flex space-x-3">
                <a href="{% url 'crm:edit' guest.id %}" 
                   class="bg-royal-500 text-white px-6 py-3 rounded-xl hover:bg-royal-600 transition-colors flex items-center space-x-2">
                    <i class="fas fa-edit"></i>
                    <span>Edit Details</span>
                </a>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Contact Information -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-luxury-800 mb-4 flex items-center">
                    <i class="fas fa-address-card mr-3 text-royal-500"></i>
                    Contact Information
                </h3>
                
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-luxury-600">Email:</span>
                        <span class="font-medium text-luxury-900">{{ guest.email }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-luxury-600">Phone:</span>
                        <span class="font-medium text-luxury-900">{{ guest.phone|default:"Not provided" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-luxury-600">Date of Birth:</span>
                        <span class="font-medium text-luxury-900">{{ guest.date_of_birth|date:"M d, Y"|default:"Not provided" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-luxury-600">Nationality:</span>
                        <span class="font-medium text-luxury-900">
                            {% if guest.nationality %}
                                {{ guest.nationality.name }}
                            {% else %}
                                Not provided
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-luxury-600">Address:</span>
                        <span class="font-medium text-luxury-900">{{ guest.address|default:"Not provided" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-luxury-600">National ID Card:</span>
                        <div class="text-right">
                            <span class="font-medium text-luxury-900">{{ guest.national_id_card|default:"Not provided" }}</span>
                            {% if guest.google_drive_file_link %}
                                <br>
                                <a href="{{ guest.google_drive_file_link }}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fab fa-google-drive mr-1"></i>View ID Card Image
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Guest Statistics -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-luxury-800 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-3 text-royal-500"></i>
                    Guest Statistics
                </h3>
                
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-luxury-600">Total Reservations:</span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">{{ guest_reservations.count }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-luxury-600">Member Since:</span>
                        <span class="font-medium text-luxury-900">{{ guest.created_at|date:"M d, Y" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-luxury-600">Last Visit:</span>
                        <span class="font-medium text-luxury-900">
                            {% if last_reservation %}
                                {{ last_reservation.check_in|date:"M d, Y" }}
                            {% else %}
                                Never
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-luxury-600">Status:</span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">Active</span>
                    </div>
                </div>
            </div>
        </div>
        
        {% if guest.notes %}
        <div class="mt-8 pt-6 border-t border-luxury-200">
            <h3 class="text-lg font-semibold text-luxury-800 mb-4 flex items-center">
                <i class="fas fa-sticky-note mr-3 text-royal-500"></i>
                Notes
            </h3>
            <div class="bg-luxury-50 rounded-xl p-4">
                <p class="text-luxury-700">{{ guest.notes }}</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Quick Actions -->
    <div class="bg-white rounded-3xl p-8 luxury-shadow">
        <h3 class="text-lg font-semibold text-luxury-800 mb-6 flex items-center">
            <i class="fas fa-bolt mr-3 text-royal-500"></i>
            Quick Actions
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="{% url 'reservations:create' %}?guest={{ guest.id }}" 
               class="p-6 border border-luxury-200 rounded-2xl hover:bg-luxury-50 hover:border-blue-300 transition-all duration-300 text-center group">
                <i class="fas fa-calendar-plus text-3xl text-blue-500 mb-3 group-hover:scale-110 transition-transform"></i>
                <p class="font-semibold text-luxury-900 mb-1">New Reservation</p>
                <p class="text-sm text-luxury-600">Create booking for {{ guest.first_name }}</p>
            </a>
            
            <button onclick="openEmailModal()" 
                    class="p-6 border border-luxury-200 rounded-2xl hover:bg-luxury-50 hover:border-green-300 transition-all duration-300 text-center group">
                <i class="fas fa-envelope text-3xl text-green-500 mb-3 group-hover:scale-110 transition-transform"></i>
                <p class="font-semibold text-luxury-900 mb-1">Send Email</p>
                <p class="text-sm text-luxury-600">Contact {{ guest.first_name }} directly</p>
            </button>
            
            <a href="{% url 'crm:guest_history' guest.id %}" 
               class="p-6 border border-luxury-200 rounded-2xl hover:bg-luxury-50 hover:border-purple-300 transition-all duration-300 text-center group">
                <i class="fas fa-history text-3xl text-purple-500 mb-3 group-hover:scale-110 transition-transform"></i>
                <p class="font-semibold text-luxury-900 mb-1">View History</p>
                <p class="text-sm text-luxury-600">See all {{ guest.first_name }}'s reservations</p>
            </a>
        </div>
    </div>
    
    <!-- Back Button -->
    <div class="flex justify-start">
        <a href="{% url 'crm:list' %}" class="bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Back to Guest List
        </a>
    </div>
</div>

<!-- Email Modal -->
<div id="emailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-t-3xl">
            <div class="flex items-center justify-between">
                <h3 class="text-2xl font-bold text-white">Send Email to {{ guest.first_name }}</h3>
                <button onclick="closeEmailModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <form method="post" action="{% url 'crm:send_email' guest.id %}" class="p-6 space-y-6">
            {% csrf_token %}
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-luxury-700 mb-2">Email Subject</label>
                    <input type="text" name="subject" id="emailSubject" 
                           class="w-full px-4 py-3 border border-luxury-200 rounded-2xl focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           placeholder="Enter email subject">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-luxury-700 mb-2">Email Message</label>
                    <textarea name="message" id="emailMessage" rows="8"
                              class="w-full px-4 py-3 border border-luxury-200 rounded-2xl focus:ring-2 focus:ring-green-500 focus:border-transparent"
                              placeholder="Write your message here..."></textarea>
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button type="button" onclick="closeEmailModal()" 
                        class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-2xl font-semibold hover:bg-gray-200 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-2xl font-semibold hover:from-green-600 hover:to-green-700 transition-all">
                    <i class="fas fa-paper-plane mr-2"></i>Send Email
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function openEmailModal() {
    // Pre-fill email content based on guest's reservation history
    const subject = document.getElementById('emailSubject');
    const message = document.getElementById('emailMessage');
    
    {% if last_reservation %}
        subject.value = "Thank you for staying with {{ hotel.name }}!";
        message.value = `Dear {{ guest.first_name }},

We hope this message finds you well! 

We wanted to reach out and thank you for choosing {{ hotel.name }} for your recent stay on {{ last_reservation.check_in|date:"F d, Y" }}. Your visit means the world to us, and we hope you had a wonderful experience.

We would love to hear about your stay! How was your experience with us? Is there anything we could have done better to make your visit even more memorable?

At {{ hotel.name }}, we are committed to providing exceptional hospitality and creating unforgettable memories for our guests. Your feedback helps us continue to improve and deliver the best possible service.

We look forward to welcoming you back soon for another amazing stay!

Warm regards,
The {{ hotel.name }} Team

---
{{ hotel.name }}
{{ hotel.address }}
{{ hotel.phone }}
{{ hotel.email }}`;
    {% else %}
        subject.value = "Welcome to {{ hotel.name }} - Discover Luxury Hospitality";
        message.value = `Dear {{ guest.first_name }},

Greetings from {{ hotel.name }}!

We are delighted to welcome you to our exclusive guest community. As one of our valued guests, we wanted to introduce you to the exceptional experiences that await you at our luxury hotel.

üè® About {{ hotel.name }}:
{{ hotel.name }} offers world-class accommodations and personalized service in the heart of {{ hotel.city }}. Our commitment to excellence ensures that every stay is memorable and comfortable.

‚ú® What We Offer:
- Luxurious rooms and suites with modern amenities
- Exceptional dining experiences
- Personalized concierge services
- State-of-the-art facilities
- Unforgettable hospitality

We would be honored to host you for your next visit. Whether you're traveling for business or leisure, our team is dedicated to making your stay extraordinary.

Feel free to contact us anytime to make a reservation or if you have any questions about our services.

We look forward to welcoming you to {{ hotel.name }} soon!

Best regards,
The {{ hotel.name }} Team

---
{{ hotel.name }}
{{ hotel.address }}
{{ hotel.phone }}
{{ hotel.email }}`;
    {% endif %}
    
    document.getElementById('emailModal').classList.remove('hidden');
}

function closeEmailModal() {
    document.getElementById('emailModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('emailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEmailModal();
    }
});
</script>

<style>
    .luxury-shadow {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
</style>
{% endblock %}