{% load static %}

<div class="activity-log-container">
    <div class="flex justify-between items-center mb-6">
        <h4 class="text-lg font-semibold text-luxury-800">Recent Activity</h4>
        <button onclick="addNote()" class="bg-gradient-to-r from-royal-500 to-royal-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-royal-600 hover:to-royal-700 transition-all duration-300 flex items-center space-x-2 luxury-shadow-sm">
            <i class="fas fa-plus"></i>
            <span>Add Note</span>
        </button>
    </div>
    
    <div class="activity-timeline">
        {% for activity in activities %}
        <div class="activity-item">
            <div class="activity-icon">
                {% if activity.action == 'status_change' %}
                    <i class="fas fa-exchange-alt text-warning"></i>
                {% elif activity.action == 'maintenance_request' %}
                    <i class="fas fa-tools text-danger"></i>
                {% elif activity.action == 'cleaning_completed' %}
                    <i class="fas fa-broom text-success"></i>
                {% elif activity.action == 'price_change' %}
                    <i class="fas fa-dollar-sign text-info"></i>
                {% elif activity.action == 'note_added' %}
                    <i class="fas fa-sticky-note text-primary"></i>
                {% elif activity.action == 'guest_checkin' %}
                    <i class="fas fa-sign-in-alt text-success"></i>
                {% elif activity.action == 'guest_checkout' %}
                    <i class="fas fa-sign-out-alt text-info"></i>
                {% elif activity.action == 'payment_received' %}
                    <i class="fas fa-credit-card text-success"></i>
                {% elif activity.action == 'reservation_created' %}
                    <i class="fas fa-calendar-plus text-primary"></i>
                {% elif activity.action == 'reservation_cancelled' %}
                    <i class="fas fa-calendar-times text-danger"></i>
                {% elif activity.action == 'housekeeping_assigned' %}
                    <i class="fas fa-user-check text-info"></i>
                {% else %}
                    <i class="fas fa-info-circle text-secondary"></i>
                {% endif %}
            </div>
            
            <div class="activity-content">
                <div class="activity-header">
                    <strong>{{ activity.get_user_display }}</strong>
                    <span class="activity-action">{{ activity.get_action_display }}</span>
                    <small class="text-muted">{{ activity.get_time_ago }} ago</small>
                </div>
                
                <div class="activity-description">
                    {{ activity.description }}
                    
                    {% if activity.metadata %}
                        {% if activity.metadata.guest_name %}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-user"></i> Guest: {{ activity.metadata.guest_name }}
                                </small>
                            </div>
                        {% endif %}
                        
                        {% if activity.metadata.total_amount %}
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-money-bill"></i> Amount: {{ activity.metadata.currency|default:"PKR" }} {{ activity.metadata.total_amount }}
                                </small>
                            </div>
                        {% endif %}
                        
                        {% if activity.metadata.check_in and activity.metadata.check_out %}
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-calendar"></i> {{ activity.metadata.check_in }} to {{ activity.metadata.check_out }}
                                </small>
                            </div>
                        {% endif %}
                        
                        {% if activity.metadata.payment_method %}
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-credit-card"></i> Payment Method: {{ activity.metadata.payment_method }}
                                </small>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                
                {% if activity.old_value and activity.new_value %}
                <div class="activity-changes mt-2">
                    <small class="text-muted">
                        <span class="badge badge-light">{{ activity.old_value }}</span>
                        <i class="fas fa-arrow-right mx-1"></i>
                        <span class="badge badge-primary">{{ activity.new_value }}</span>
                    </small>
                </div>
                {% endif %}
                
                <div class="activity-timestamp">
                    <small class="text-muted">{{ activity.created_at|date:"M d, Y H:i" }}</small>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted py-4">
            <i class="fas fa-history fa-2x mb-2"></i>
            <p>No activity recorded yet</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Add Note Modal -->
<div id="addNoteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 luxury-shadow">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-luxury-900">Add Note</h3>
            <button onclick="closeModal()" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">
                <i class="fas fa-times text-gray-600"></i>
            </button>
        </div>
        <form id="addNoteForm">
            <div class="mb-6">
                <label class="block text-sm font-medium text-luxury-700 mb-2">Note</label>
                <textarea name="note" rows="4" required placeholder="Enter your note..." 
                         class="w-full px-4 py-3 border border-luxury-200 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent resize-none"></textarea>
            </div>
            <div class="flex space-x-3">
                <button type="submit" class="flex-1 bg-gradient-to-r from-royal-500 to-royal-600 text-white py-3 rounded-xl font-semibold hover:from-royal-600 hover:to-royal-700 transition-all duration-300">
                    Add Note
                </button>
                <button type="button" onclick="closeModal()" class="flex-1 bg-luxury-200 text-luxury-700 py-3 rounded-xl font-semibold hover:bg-luxury-300 transition-colors">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.activity-log-container {
    max-height: 500px;
    overflow-y: auto;
}

.luxury-shadow-sm {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.activity-timeline {
    position: relative;
    padding-left: 30px;
}

.activity-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e5e7eb;
}

.activity-item {
    position: relative;
    margin-bottom: 20px;
    background: #f9fafb;
    border-radius: 12px;
    padding: 16px;
    border-left: 3px solid #6366f1;
}

.activity-icon {
    position: absolute;
    left: -45px;
    top: 15px;
    width: 30px;
    height: 30px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.activity-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.activity-action {
    background: #6366f1;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.activity-description {
    color: #4b5563;
    margin-bottom: 8px;
}

.activity-changes {
    padding: 8px;
    background: #e5e7eb;
    border-radius: 8px;
}

.activity-timestamp {
    font-size: 11px;
}
</style>

<script>
function addNote() {
    document.getElementById('addNoteModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('addNoteModal').classList.add('hidden');
    document.getElementById('addNoteForm').reset();
}

// Close modal when clicking outside
document.getElementById('addNoteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

document.getElementById('addNoteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const note = this.querySelector('[name="note"]').value;
    
    fetch('{% url "hotels:add_room_note" room.room_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
            'note': note
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error adding note: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error adding note');
    });
});
</script>