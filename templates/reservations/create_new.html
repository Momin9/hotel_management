{% extends 'base_luxury.html' %}

{% block title %}New Reservation - AuraStay{% endblock %}
{% block page_title %}Create Reservation{% endblock %}
{% block page_subtitle %}Book a room for your guest{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-3xl p-8 luxury-shadow">
        <form method="post" id="reservationForm" class="space-y-6">
            {% csrf_token %}
            
            <!-- Validation Summary (will be populated by JavaScript) -->
            <div class="validation-summary" style="display: none;">
                <h4><i class="fas fa-exclamation-triangle"></i> Please correct the following errors:</h4>
                <ul></ul>
            </div>

            <!-- Guest Selection -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-luxury-800 flex items-center">
                    <i class="fas fa-user mr-3 text-royal-500"></i>
                    Guest Information
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="validation-container">
                        <label for="guestSelect" class="block text-sm font-medium text-luxury-700 mb-2 required">Select Guest</label>
                        <select name="guest" id="guestSelect" required
                                class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                            <option value="">Choose existing guest or create new</option>
                            <option value="new">+ Create New Guest</option>
                            {% for guest in guests %}
                            <option value="{{ guest.id }}">{{ guest.full_name }} - {{ guest.email }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div id="newGuestBtn" class="hidden">
                        <label class="block text-sm font-medium text-luxury-700 mb-2">&nbsp;</label>
                        <button type="button" onclick="showNewGuestForm()" 
                                class="w-full px-4 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Create New Guest
                        </button>
                    </div>
                </div>
                
                <!-- New Guest Form (Hidden by default) -->
                <div id="newGuestForm" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-luxury-50 rounded-xl">
                    <div class="validation-container">
                        <label for="guest_first_name" class="block text-sm font-medium text-luxury-700 mb-2 required">First Name</label>
                        <input type="text" name="guest_first_name" id="guest_first_name"
                               class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                    </div>
                    <div class="validation-container">
                        <label for="guest_last_name" class="block text-sm font-medium text-luxury-700 mb-2 required">Last Name</label>
                        <input type="text" name="guest_last_name" id="guest_last_name"
                               class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                    </div>
                    <div class="validation-container">
                        <label for="guest_email" class="block text-sm font-medium text-luxury-700 mb-2 required">Email</label>
                        <input type="email" name="guest_email" id="guest_email"
                               class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                    </div>
                    <div class="validation-container">
                        <label for="guest_phone" class="block text-sm font-medium text-luxury-700 mb-2">Phone</label>
                        <input type="tel" name="guest_phone" id="guest_phone"
                               class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                    </div>
                </div>
            </div>

            <!-- Vehicle Information -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-luxury-800 flex items-center">
                    <i class="fas fa-car mr-3 text-royal-500"></i>
                    Vehicle Information
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="validation-container">
                        <label for="vehicle_type" class="block text-sm font-medium text-luxury-700 mb-2">Vehicle Type</label>
                        <select name="vehicle_type" id="vehicle_type"
                                class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                            <option value="">Select Vehicle Type</option>
                            <option value="Car">Car</option>
                            <option value="SUV">SUV</option>
                            <option value="Motorcycle">Motorcycle</option>
                            <option value="Van">Van</option>
                            <option value="Truck">Truck</option>
                            <option value="Bus">Bus</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="validation-container">
                        <label for="vehicle_registration" class="block text-sm font-medium text-luxury-700 mb-2">Vehicle Registration Number</label>
                        <input type="text" name="vehicle_registration" id="vehicle_registration" placeholder="e.g., ABC-123 or ABC1234"
                               class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                    </div>
                </div>
            </div>
            
            <!-- Booking Details -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-luxury-800 flex items-center">
                    <i class="fas fa-calendar mr-3 text-royal-500"></i>
                    Booking Details
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="validation-container">
                        <label for="hotelSelect" class="block text-sm font-medium text-luxury-700 mb-2 required">Hotel</label>
                        <select name="hotel" id="hotelSelect" required onchange="checkAvailability()"
                                class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                            <option value="">Select Hotel</option>
                            {% for hotel in hotels %}
                            <option value="{{ hotel.hotel_id }}" {% if hotel == default_hotel %}selected{% endif %}>{{ hotel.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="validation-container">
                        <label for="reservation_type" class="block text-sm font-medium text-luxury-700 mb-2 required">Reservation Type</label>
                        <select name="reservation_type" id="reservation_type" required
                                class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                            <option value="reservation">Reservation (Future booking)</option>
                            <option value="booking">Booking (Immediate check-in)</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="validation-container">
                        <label for="checkInDate" class="block text-sm font-medium text-luxury-700 mb-2 required">Check-in Date</label>
                        <input type="date" name="check_in" id="checkInDate" required onchange="checkAvailability()" data-min-date="today"
                               class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                    </div>
                    
                    <div class="validation-container">
                        <label for="checkOutDate" class="block text-sm font-medium text-luxury-700 mb-2 required">Check-out Date</label>
                        <input type="date" name="check_out" id="checkOutDate" required onchange="checkAvailability()"
                               class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="validation-container">
                        <label for="adults" class="block text-sm font-medium text-luxury-700 mb-2 required">Adults</label>
                        <input type="number" name="adults" id="adults" value="1" min="1" required
                               class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                    </div>
                    
                    <div class="validation-container">
                        <label for="children" class="block text-sm font-medium text-luxury-700 mb-2">Children</label>
                        <input type="number" name="children" id="children" value="0" min="0"
                               class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent">
                    </div>
                </div>
            </div>
            
            <!-- Room Selection -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-luxury-800 flex items-center">
                    <i class="fas fa-bed mr-3 text-royal-500"></i>
                    Available Rooms
                </h3>
                
                <!-- Room Filters - Always Visible -->
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%); padding: 24px; border-radius: 16px; border: 2px solid #e2e8f0; margin-bottom: 16px;">
                    <h4 style="font-size: 16px; font-weight: 600; color: #1e293b; margin-bottom: 16px; display: flex; align-items: center;">
                        <i class="fas fa-filter" style="margin-right: 8px; color: #3b82f6;"></i>
                        Filter Available Rooms
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #334155; margin-bottom: 8px;">Room Type</label>
                            <select id="roomTypeFilter" onchange="filterRooms()" style="width: 100%; padding: 12px 16px; border: 2px solid #cbd5e1; border-radius: 12px; background: white; font-size: 14px;">
                                <option value="">All Room Types</option>
                                <option value="Standard">Standard Room</option>
                                <option value="Deluxe">Deluxe Room</option>
                                <option value="Suite">Suite</option>
                                <option value="Executive">Executive Room</option>
                            </select>
                        </div>

                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 500; color: #334155; margin-bottom: 8px;">Bed Type</label>
                            <select id="bedTypeFilter" onchange="filterRooms()" style="width: 100%; padding: 12px 16px; border: 2px solid #cbd5e1; border-radius: 12px; background: white; font-size: 14px;">
                                <option value="">All Bed Types</option>
                                <option value="Single">Single Bed</option>
                                <option value="Double">Double Bed</option>
                                <option value="Queen">Queen Bed</option>
                                <option value="King">King Bed</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="availableRooms" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="text-center py-8 text-luxury-600">
                        <i class="fas fa-search text-4xl mb-4 text-luxury-300"></i>
                        <p>Select hotel and dates to see available rooms</p>
                    </div>
                </div>
            </div>
            
            <!-- Special Requests -->
            <div class="validation-container">
                <label for="special_requests" class="block text-sm font-medium text-luxury-700 mb-2">Special Requests</label>
                <textarea name="special_requests" id="special_requests" rows="3" placeholder="Any special requirements or requests..."
                          class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent"></textarea>
            </div>
            
            <div class="flex space-x-4">
                <button type="submit" id="submitBtn" class="bg-royal-500 text-white px-6 py-3 rounded-xl hover:bg-royal-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-calendar-check mr-2"></i>Create Reservation
                </button>
                <a href="{% url 'reservations:list' %}" class="bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600 transition-colors">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Initialize form and room availability checking
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reservationForm');
    const submitBtn = document.getElementById('submitBtn');

    // Disable submit button initially
    submitBtn.disabled = true;

    // Set minimum dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('checkInDate').min = today;
    document.getElementById('checkOutDate').min = today;

    // Auto-check availability if hotel is pre-selected
    const hotelSelect = document.getElementById('hotelSelect');
    if (hotelSelect.value) {
        setTimeout(checkAvailability, 100);
    }

    // Enable submit when room is selected
    document.addEventListener('change', function(e) {
        if (e.target.name === 'room') {
            submitBtn.disabled = false;
        }
    });

    // Form submission validation
    form.addEventListener('submit', function(e) {
        console.log('Form submission started');

        const selectedRoom = document.querySelector('input[name="room"]:checked');
        const guestSelect = document.getElementById('guestSelect').value;
        const hotelSelect = document.getElementById('hotelSelect').value;
        const checkInDate = document.getElementById('checkInDate').value;
        const checkOutDate = document.getElementById('checkOutDate').value;

        console.log('Form validation:', {
            selectedRoom: selectedRoom ? selectedRoom.value : 'none',
            guestSelect,
            hotelSelect,
            checkInDate,
            checkOutDate
        });

        let errors = [];

        // Basic validation
        if (!guestSelect) errors.push('Please select a guest.');
        if (!hotelSelect) errors.push('Please select a hotel.');
        if (!checkInDate) errors.push('Please select check-in date.');
        if (!checkOutDate) errors.push('Please select check-out date.');
        if (!selectedRoom) {
            // Check if any room is visually selected
            const visuallySelected = document.querySelector('.room-option.border-royal-500');
            if (!visuallySelected) {
                errors.push('Please select a room.');
            }
        }

        // Date validation
        if (checkInDate && checkOutDate && new Date(checkInDate) >= new Date(checkOutDate)) {
            errors.push('Check-out date must be after check-in date.');
        }

        // New guest validation
        if (guestSelect === 'new') {
            const firstName = document.getElementById('guest_first_name').value.trim();
            const lastName = document.getElementById('guest_last_name').value.trim();
            const email = document.getElementById('guest_email').value.trim();

            if (!firstName) errors.push('Guest first name is required.');
            if (!lastName) errors.push('Guest last name is required.');
            if (!email) errors.push('Guest email is required.');
        }

        if (errors.length > 0) {
            console.log('Form validation errors:', errors);
            e.preventDefault();
            alert('Please fix the following errors:\n\n' + errors.join('\n'));
            return false;
        }

        console.log('Form validation passed, submitting...');

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Reservation...';

        return true;
    });
});

// Guest selection handling
document.getElementById('guestSelect').addEventListener('change', function() {
    const newGuestBtn = document.getElementById('newGuestBtn');
    const newGuestForm = document.getElementById('newGuestForm');
    
    if (this.value === 'new') {
        newGuestBtn.classList.remove('hidden');
        newGuestForm.classList.remove('hidden');
    } else {
        newGuestBtn.classList.add('hidden');
        newGuestForm.classList.add('hidden');
    }
});

function showNewGuestForm() {
    document.getElementById('newGuestForm').classList.remove('hidden');
}

let allRooms = [];

function checkAvailability() {
    const hotel = document.getElementById('hotelSelect').value;
    const checkIn = document.getElementById('checkInDate').value;
    const checkOut = document.getElementById('checkOutDate').value;
    
    console.log('Checking availability:', { hotel, checkIn, checkOut });

    if (!hotel || !checkIn || !checkOut) {
        console.log('Missing required fields for availability check');
        return;
    }
    
    const availableRoomsDiv = document.getElementById('availableRooms');
    availableRoomsDiv.innerHTML = '<div class="text-center py-8 col-span-2"><i class="fas fa-spinner fa-spin text-2xl text-royal-500"></i><p class="mt-2 text-luxury-600">Checking availability...</p></div>';
    
    const url = `{% url 'reservations:check_availability' %}?hotel_id=${encodeURIComponent(hotel)}&check_in=${encodeURIComponent(checkIn)}&check_out=${encodeURIComponent(checkOut)}`;
    console.log('Fetching:', url);

    fetch(url)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Availability data:', data);
            if (data.rooms && data.rooms.length > 0) {
                allRooms = data.rooms;
                displayRooms(allRooms);
                // Reset filters
                document.getElementById('roomTypeFilter').value = '';
                document.getElementById('bedTypeFilter').value = '';
            } else {
                availableRoomsDiv.innerHTML = `
                    <div class="text-center py-8 text-luxury-600 col-span-2">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4 text-yellow-500"></i>
                        <p class="font-semibold">No rooms available for selected dates</p>
                        <p class="text-sm mt-2">Please try different dates or contact reception</p>
                        ${data.debug ? `<p class="text-xs mt-2 text-gray-500">Hotel: ${data.debug.hotel_name}, Total rooms: ${data.debug.all_room_numbers?.length || 0}</p>` : ''}
                    </div>
                `;
                allRooms = [];
            }
        })
        .catch(error => {
            console.error('Availability check error:', error);
            availableRoomsDiv.innerHTML = `
                <div class="text-center py-8 text-red-600 col-span-2">
                    <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                    <p class="font-semibold">Error checking availability</p>
                    <p class="text-sm mt-2">Please try again or contact support</p>
                    <p class="text-xs mt-2 text-gray-500">${error.message}</p>
                </div>
            `;
            allRooms = [];
        });
}

function displayRooms(rooms) {
    const availableRoomsDiv = document.getElementById('availableRooms');
    let roomsHtml = '';

    rooms.forEach(room => {
        roomsHtml += `
            <div class="border border-luxury-200 rounded-xl p-4 hover:bg-luxury-50 transition-colors cursor-pointer room-option"
                 onclick="selectRoom(${room.id}, '${room.number}', '${room.type}', ${room.price})"
                 data-room-type="${room.type}" data-bed-type="${room.bed}">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-luxury-800">Room ${room.number}</h4>
                    <span class="text-lg font-bold text-royal-600">$${room.price}</span>
                </div>
                <p class="text-luxury-600 text-sm">${room.type} • ${room.category}</p>
                <p class="text-luxury-500 text-xs">${room.bed} • ${room.floor}</p>
                <input type="radio" name="room" value="${room.id}" class="hidden room-radio">
            </div>
        `;
    });

    availableRoomsDiv.innerHTML = roomsHtml;
}

function filterRooms() {
    const roomTypeFilter = document.getElementById('roomTypeFilter').value;
    const bedTypeFilter = document.getElementById('bedTypeFilter').value;

    console.log('Filtering rooms:', { roomTypeFilter, bedTypeFilter, totalRooms: allRooms.length });

    if (!allRooms || allRooms.length === 0) {
        console.log('No rooms to filter');
        return;
    }

    let filteredRooms = [...allRooms]; // Create a copy

    if (roomTypeFilter) {
        filteredRooms = filteredRooms.filter(room => {
            const roomType = room.type || room.category || '';
            return roomType.toLowerCase().includes(roomTypeFilter.toLowerCase());
        });
        console.log('After room type filter:', filteredRooms.length);
    }

    if (bedTypeFilter) {
        filteredRooms = filteredRooms.filter(room => {
            const bedType = room.bed || '';
            return bedType.toLowerCase().includes(bedTypeFilter.toLowerCase());
        });
        console.log('After bed type filter:', filteredRooms.length);
    }

    if (filteredRooms.length > 0) {
        displayRooms(filteredRooms);
    } else {
        document.getElementById('availableRooms').innerHTML = `
            <div class="text-center py-8 text-luxury-600 col-span-2">
                <i class="fas fa-filter text-4xl mb-4 text-luxury-300"></i>
                <p class="font-semibold">No rooms match the selected filters</p>
                <p class="text-sm mt-2">Try adjusting your filters or clearing them</p>
                <button onclick="clearFilters()" class="mt-3 px-4 py-2 bg-royal-500 text-white rounded-lg hover:bg-royal-600 transition-colors">
                    Clear Filters
                </button>
            </div>
        `;
    }
}

function clearFilters() {
    document.getElementById('roomTypeFilter').value = '';
    document.getElementById('bedTypeFilter').value = '';
    if (allRooms && allRooms.length > 0) {
        displayRooms(allRooms);
    }
}

function selectRoom(roomId, roomNumber, roomType, price) {
    console.log('Selecting room:', roomId);

    // Remove previous selections
    document.querySelectorAll('.room-option').forEach(el => {
        el.classList.remove('border-royal-500', 'bg-royal-50');
        el.classList.add('border-luxury-200');
    });
    
    // Select current room
    const currentRoom = event.currentTarget;
    currentRoom.classList.remove('border-luxury-200');
    currentRoom.classList.add('border-royal-500', 'bg-royal-50');
    
    // Find and check the radio button inside this room
    const radioButton = currentRoom.querySelector('input[name="room"]');
    if (radioButton) {
        radioButton.checked = true;
        console.log('Room radio button checked:', radioButton.checked, 'Value:', radioButton.value);
    }

    // Enable submit button
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = false;
    console.log('Submit button enabled');
}

// Update checkout min date when checkin changes
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('checkInDate').addEventListener('change', function() {
        const checkInDate = new Date(this.value);
        checkInDate.setDate(checkInDate.getDate() + 1);
        document.getElementById('checkOutDate').min = checkInDate.toISOString().split('T')[0];

        // Clear checkout date if it's before new checkin date
        const checkOutInput = document.getElementById('checkOutDate');
        if (checkOutInput.value && checkOutInput.value <= this.value) {
            checkOutInput.value = '';
        }

        // Trigger availability check
        checkAvailability();
    });

    // Validate checkout date is after checkin date
    document.getElementById('checkOutDate').addEventListener('change', function() {
        const checkInDate = document.getElementById('checkInDate').value;
        if (checkInDate && this.value <= checkInDate) {
            alert('Check-out date must be after check-in date.');
            this.value = '';
            return;
        }

        // Trigger availability check
        checkAvailability();
    });
});
</script>

<style>
    .luxury-shadow {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    /* Advanced room selection styling */
    .room-option {
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .room-option:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px -8px rgba(0, 0, 0, 0.2);
        border-color: #3b82f6 !important;
    }

    .room-option.selected-room {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -8px rgba(59, 130, 246, 0.3);
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%) !important;
        border: 2px solid #3b82f6 !important;
    }

    .selected-indicator {
        animation: checkmark 0.3s ease-in-out;
    }

    @keyframes checkmark {
        0% { transform: scale(0) rotate(0deg); }
        50% { transform: scale(1.2) rotate(180deg); }
        100% { transform: scale(1) rotate(360deg); }
    }

    /* Ensure filters are visible */
    #roomTypeFilter, #bedTypeFilter {
        appearance: auto;
        -webkit-appearance: menulist;
        -moz-appearance: menulist;
    }

    /* Custom luxury colors */
    .luxury-50 { background-color: #f8fafc; }
    .luxury-100 { background-color: #f1f5f9; }
    .luxury-200 { background-color: #e2e8f0; }
    .luxury-300 { background-color: #cbd5e1; }
    .luxury-600 { color: #475569; }
    .luxury-700 { color: #334155; }
    .luxury-800 { color: #1e293b; }
    .royal-50 { background-color: #eff6ff; }
    .royal-500 { color: #3b82f6; }
    .royal-600 { color: #2563eb; }
</style>
{% endblock %}