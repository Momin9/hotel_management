{% extends 'base_luxury.html' %}

{% block title %}
    {% if company %}Edit Company - {{ company.name }}{% else %}Add Company Contract{% endif %}
{% endblock %}

{% block page_title %}
    {% if company %}Edit Company Contract{% else %}Add Company Contract{% endif %}
{% endblock %}

{% block page_subtitle %}
    {% if company %}Update contract details for {{ company.name }}{% else %}Create a new corporate client contract{% endif %}
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Form Container -->
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl luxury-shadow overflow-hidden">
            <!-- Form Header -->
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-8 relative overflow-hidden">
                <div class="absolute inset-0 bg-black/10"></div>
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-16 translate-x-16"></div>
                <div class="relative flex items-center space-x-4">
                    <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-building text-white text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-white">
                            {% if company %}Edit Contract{% else %}New Contract{% endif %}
                        </h2>
                        <p class="text-orange-100">
                            {% if company %}{{ company.name }}{% else %}Corporate Client Agreement{% endif %}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Form Content -->
            <div class="p-8">
                <form method="post" enctype="multipart/form-data" class="space-y-8">
                    {% csrf_token %}
                    
                    <!-- Company Information -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-building text-orange-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-luxury-800">Company Information</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="name" class="block text-sm font-semibold text-luxury-700">Company Name *</label>
                                {{ form.name }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="business_type" class="block text-sm font-semibold text-luxury-700">Business Type</label>
                                {{ form.business_type }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="logo" class="block text-sm font-semibold text-luxury-700">Company Logo (Optional)</label>
                                {{ form.logo }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="registration_number" class="block text-sm font-semibold text-luxury-700">Registration/Tax Number</label>
                                {{ form.registration_number }}
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-map-marker-alt text-blue-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-luxury-800">Contact Information</h3>
                        </div>

                        <div class="space-y-2">
                            <label for="address" class="block text-sm font-semibold text-luxury-700">Registered Address</label>
                            {{ form.address }}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label for="city" class="block text-sm font-semibold text-luxury-700">City</label>
                                {{ form.city }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="state" class="block text-sm font-semibold text-luxury-700">State/Province</label>
                                {{ form.state }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="country" class="block text-sm font-semibold text-luxury-700">Country</label>
                                {{ form.country }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label for="phone" class="block text-sm font-semibold text-luxury-700">Phone Number</label>
                                {{ form.phone }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="email" class="block text-sm font-semibold text-luxury-700">Company Email</label>
                                {{ form.email }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="website" class="block text-sm font-semibold text-luxury-700">Website (Optional)</label>
                                {{ form.website }}
                            </div>
                        </div>
                    </div>

                    <!-- Authorized Person -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user-tie text-green-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-luxury-800">Authorized Person</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="contact_person" class="block text-sm font-semibold text-luxury-700">Contact Person Name</label>
                                {{ form.contact_person }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="designation" class="block text-sm font-semibold text-luxury-700">Designation</label>
                                {{ form.designation }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="mobile_number" class="block text-sm font-semibold text-luxury-700">Mobile Number</label>
                                {{ form.mobile_number }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="contact_email" class="block text-sm font-semibold text-luxury-700">Contact Email</label>
                                {{ form.contact_email }}
                            </div>
                        </div>
                    </div>

                    <!-- Contract Details -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-contract text-purple-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-luxury-800">Contract Details</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="contract_start_date" class="block text-sm font-semibold text-luxury-700">Contract Start Date</label>
                                {{ form.contract_start_date }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="contract_end_date" class="block text-sm font-semibold text-luxury-700">Contract End Date</label>
                                {{ form.contract_end_date }}
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label for="hotel_select" class="block text-sm font-semibold text-luxury-700">Hotel</label>
                            <select id="hotel_select" name="hotel" class="w-full px-4 py-3 border border-luxury-300 rounded-xl focus:ring-2 focus:ring-royal-500 focus:border-transparent" onchange="loadRoomTypes()" {% if not user.is_superuser and user.role != 'Owner' %}disabled{% endif %}>
                                {% if user.is_superuser or user.role == 'Owner' %}
                                <option value="">Select Hotel</option>
                                {% for hotel_option in available_hotels %}
                                <option value="{{ hotel_option.hotel_id }}" {% if hotel_option == hotel %}selected{% endif %}>{{ hotel_option.name }}</option>
                                {% endfor %}
                                {% else %}
                                <option value="{{ hotel.hotel_id }}" selected>{{ hotel.name }}</option>
                                {% endif %}
                            </select>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-luxury-700">Approved Room Types</label>
                            <div class="bg-luxury-50 p-6 rounded-xl border border-luxury-200" id="room-types-container">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="room-types-grid">
                                    {% for choice in form.approved_room_types %}
                                    <div class="flex items-center space-x-3 p-3 border border-luxury-200 rounded-xl hover:bg-luxury-50 transition-colors">
                                        {{ choice.tag }}
                                        <label for="{{ choice.id_for_label }}" class="flex-1 cursor-pointer">
                                            <div class="font-medium text-luxury-800 flex items-center">
                                                <i class="fas fa-bed mr-2 text-orange-600"></i>
                                                {{ choice.choice_label }}
                                            </div>
                                        </label>
                                    </div>
                                    {% empty %}
                                    <div class="col-span-full text-center py-8 text-luxury-500" id="no-room-types">
                                        <i class="fas fa-info-circle text-2xl mb-2"></i>
                                        <p>Select a hotel to view room types.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <script>
                        function loadRoomTypes() {
                            const hotelId = document.getElementById('hotel_select').value;
                            const container = document.getElementById('room-types-grid');
                            
                            if (!hotelId) {
                                container.innerHTML = '<div class="col-span-full text-center py-8 text-luxury-500"><i class="fas fa-info-circle text-2xl mb-2"></i><p>Select a hotel to view room types.</p></div>';
                                return;
                            }
                            
                            fetch(`/hotels/api/room-types/${hotelId}/`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.room_types.length === 0) {
                                        container.innerHTML = '<div class="col-span-full text-center py-8 text-luxury-500"><i class="fas fa-info-circle text-2xl mb-2"></i><p>No room types configured for this hotel.</p></div>';
                                        return;
                                    }
                                    
                                    let html = '';
                                    data.room_types.forEach(roomType => {
                                        html += `
                                            <div class="flex items-center space-x-3 p-3 border border-luxury-200 rounded-xl hover:bg-luxury-50 transition-colors">
                                                <input type="checkbox" name="approved_room_types" value="${roomType.id}" id="id_approved_room_types_${roomType.id}" class="rounded border-luxury-300 text-royal-600 focus:ring-royal-500">
                                                <label for="id_approved_room_types_${roomType.id}" class="flex-1 cursor-pointer">
                                                    <div class="font-medium text-luxury-800 flex items-center">
                                                        <i class="fas fa-bed mr-2 text-orange-600"></i>
                                                        ${roomType.name}
                                                    </div>
                                                </label>
                                            </div>
                                        `;
                                    });
                                    container.innerHTML = html;
                                })
                                .catch(error => {
                                    console.error('Error loading room types:', error);
                                    container.innerHTML = '<div class="col-span-full text-center py-8 text-luxury-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>Error loading room types.</p></div>';
                                });
                        }
                        </script>



                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label for="corporate_discount" class="block text-sm font-semibold text-luxury-700">Corporate Discount (%)</label>
                                {{ form.corporate_discount }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="billing_mode" class="block text-sm font-semibold text-luxury-700">Billing Mode</label>
                                {{ form.billing_mode }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="status" class="block text-sm font-semibold text-luxury-700">Status</label>
                                {{ form.status }}
                            </div>
                        </div>
                    </div>

                    <!-- Legacy Contract Terms -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-handshake text-green-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-luxury-800">Additional Terms</h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="credit_limit" class="block text-sm font-semibold text-luxury-700">Credit Limit</label>
                                {{ form.credit_limit }}
                            </div>
                            
                            <div class="space-y-2">
                                <label for="payment_terms" class="block text-sm font-semibold text-luxury-700">Payment Terms</label>
                                {{ form.payment_terms }}
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-3 mb-6">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-sticky-note text-blue-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-luxury-800">Additional Information</h3>
                        </div>

                        <div class="space-y-2">
                            <label for="notes" class="block text-sm font-semibold text-luxury-700">Contract Notes</label>
                            {{ form.notes }}
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-8 border-t border-luxury-200">
                        <a href="{% url 'hotels:company_list' hotel.hotel_id %}" 
                           class="flex-1 bg-luxury-100 text-luxury-700 py-4 rounded-2xl font-semibold text-center hover:bg-luxury-200 transition-all duration-300 group">
                            <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i>
                            Back to Companies
                        </a>
                        <button type="submit" 
                                class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white py-4 rounded-2xl font-semibold hover-lift transition-all duration-300 group">
                            <i class="fas fa-save mr-2 group-hover:scale-110 transition-transform"></i>
                            {% if company %}Update Contract{% else %}Create Contract{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .hover-lift:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.25);
    }
    
    .luxury-shadow {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
</style>
{% endblock %}